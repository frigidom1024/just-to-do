# 数据库连接单元测试设计

## 测试文件结构

根据用户要求，测试文件将创建在 `src/test` 目录下，与原代码包结构对应：

```
src/
├── test/
│   ├── infrastructure/
│   │   ├── config/
│   │   │   └── db_config_test.go     # 配置加载测试
│   │   └── persistence/
│   │       └── mysql/
│   │           └── db_test.go        # 数据库连接测试
```

## 测试用例设计

### 1. 配置加载测试 (`db_config_test.go`)

| 测试用例     | 预期结果                      |
| -------- | ------------------------- |
| 测试加载有效配置 | 成功加载配置，返回正确的MySQLConfig对象 |
| 测试默认配置值  | 当配置项缺失时，使用正确的默认值          |
| 测试无效配置验证 | 无效配置（如空主机名、无效端口）返回错误      |
| 测试DSN生成  | 正确生成MySQL连接字符串            |

### 2. 数据库连接测试 (`db_test.go`)

| 测试用例     | 预期结果                     |
| -------- | ------------------------ |
| 测试创建新连接  | 成功创建数据库连接对象              |
| 测试连接池设置  | 连接池参数（最大连接数、最大空闲连接数）设置正确 |
| 测试连接关闭   | 成功关闭数据库连接                |
| 测试连接健康检查 | PingContext成功验证连接健康状态    |
| 测试单例模式   | GetClient()多次调用返回同一个实例   |

## 测试实现策略

1. **使用测试配置文件**

   * 在 `src/test` 目录下创建测试专用的config.yml.test文件

   * 测试前临时替换配置文件路径或使用viper的Set方法直接设置配置

2. **测试依赖注入**

   * 使用mock或依赖注入来模拟配置加载

   * 避免测试依赖外部配置文件

3. **测试清理**

   * 确保测试后关闭所有数据库连接

   * 避免资源泄漏

## 测试代码实现

### 配置加载测试示例

```go
package config

import (
    "testing"
    "github.com/stretchr/testify/assert"
    "github.com/spf13/viper"
    "todolist/internal/infrastructure/config"
)

func TestLoadMySQLConfig(t *testing.T) {
    // 设置测试配置
    viper.Set("mysql.host", "localhost")
    viper.Set("mysql.port", 3306)
    viper.Set("mysql.db", "test_db")
    viper.Set("mysql.user", "test_user")
    viper.Set("mysql.password", "test_pass")
    
    cfg, err := config.LoadMySQLConfig()
    assert.NoError(t, err)
    assert.NotNil(t, cfg)
    assert.Equal(t, "localhost", cfg.Host)
    assert.Equal(t, 3306, cfg.Port)
}
```

### 数据库连接测试示例

```go
package mysql

import (
    "context"
    "testing"
    "time"
    "github.com/stretchr/testify/assert"
    "todolist/internal/infrastructure/persistence/mysql"
)

func TestNewClient(t *testing.T) {
    // 测试创建数据库连接
    client, err := mysql.NewClient()
    assert.NoError(t, err)
    assert.NotNil(t, client)
    
    // 测试连接池设置
    db := client.GetDB()
    assert.NotNil(t, db)
    assert.GreaterOrEqual(t, db.Stats().MaxOpenConnections, 10)
    
    // 测试健康检查
    ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
    defer cancel()
    err = db.PingContext(ctx)
    assert.NoError(t, err)
    
    // 测试关闭连接
    err = client.Close()
    assert.NoError(t, err)
}
```

## 测试依赖

1. **测试框架**：使用Go标准库的testing包
2. **断言库**：使用github.com/stretchr/testify/assert简化断言
3. **配置管理**：使用github.com/spf13/viper加载配置
4. **数据库驱动**：github.com/go-sql-driver/mysql
5. **数据库扩展库**：github.com/jmoiron/sqlx

## 测试运行命令

```bash
# 运行所有测试
cd src && go test ./test/... -v

# 运行特定测试文件
cd src && go test ./test/infrastructure/config -v
cd src && go test ./test/infrastructure/persistence/mysql -v
```

## 注意事项

1. **测试环境隔离**：确保测试不会影响生产数据库
2. **测试速度**：避免长时间运行的测试，考虑使用内存数据库或模拟
3. **资源清理**：确保所有测试后关闭数据库连接
4. **并发安全**：测试单例模式时要考虑并发场景
5. **错误处理**：测试各种错误情况，如连接失败、超时等
